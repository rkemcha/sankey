<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-sankey@0.9.1/dist/d3-sankey.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .sankey { width: 1000px; height: 800px; }
    .legend { margin: 20px 0; }
  </style>
</head>
<body>
  <h1>Medical Patient Flow Sankey Diagram</h1>
  <div class="legend">
    <p>Analysis Approaches: <span style="color: #0066cc">Per Protocol</span> | <span style="color: #cc0000">Intention to Treat (Rescue Tx)</span></p>
    <p>Outcomes: <span style="color: #4CAF50">Success</span> | <span style="color: #FF9800">Complications</span> | <span style="color: #F44336">Revision Surgery</span></p>
  </div>
  
  <div class="sankey"></div>

  <script>
    // Create sample data based on your table structure
    const data = {
      nodes: [
        { id: "Per Protocol" },
        { id: "Intention to Treat (Rescue Tx)" },
        { id: "Initial Tx (N1)" },
        { id: "2nd phase Tx (N2)" },
        { id: "Concomitant Tx" },
        { id: "Dt Tx" },
        { id: "Surgery" },
        { id: "Abx" },
        { id: "Success" },
        { id: "Complications (Failure?)" },
        { id: "Revision surgery" },
        { id: "Non-Conserv Dt Tx" },
        { id: "Recurrence" },
        { id: "AE" },
        { id: "ESS" },
        { id: "Combined ESS" }
      ],
      links: [
        // Per Protocol flow
        { source: "Per Protocol", target: "Initial Tx (N1)", value: 150 },
        { source: "Initial Tx (N1)", target: "2nd phase Tx (N2)", value: 130 },
        { source: "2nd phase Tx (N2)", target: "Success", value: 85 },
        { source: "2nd phase Tx (N2)", target: "Complications (Failure?)", value: 35 },
        { source: "2nd phase Tx (N2)", target: "Revision surgery", value: 10 },
        { source: "2nd phase Tx (N2)", target: "Recurrence", value: 5 },
        
        // Intention to Treat (Rescue Tx) flow
        { source: "Intention to Treat (Rescue Tx)", target: "Initial Tx (N1)", value: 180 },
        { source: "Initial Tx (N1)", target: "2nd phase Tx (N2)", value: 160 },
        { source: "2nd phase Tx (N2)", target: "Success", value: 70 },
        { source: "2nd phase Tx (N2)", target: "Complications (Failure?)", value: 60 },
        { source: "2nd phase Tx (N2)", target: "Revision surgery", value: 20 },
        { source: "2nd phase Tx (N2)", target: "Recurrence", value: 10 },
        
        // Specific treatment paths
        { source: "2nd phase Tx (N2)", target: "ESS", value: 50 },
        { source: "2nd phase Tx (N2)", target: "Combined ESS", value: 40 },
        { source: "ESS", target: "Success", value: 35 },
        { source: "ESS", target: "Complications (Failure?)", value: 15 },
        { source: "Combined ESS", target: "Success", value: 25 },
        { source: "Combined ESS", target: "Complications (Failure?)", value: 15 },
        
        // Additional pathways from the table
        { source: "2nd phase Tx (N2)", target: "Non-Conserv Dt Tx", value: 15 },
        { source: "2nd phase Tx (N2)", target: "AE", value: 10 }
      ]
    };

    // Set up the SVG container
    const width = 1000;
    const height = 800;
    
    const svg = d3.select(".sankey")
      .append("svg")
      .attr("width", width)
      .attr("height", height);
    
    // Create Sankey layout
    const sankey = d3 sankey()
      .nodeWidth(20)
      .nodePadding(20)
      .size([width, height - 200])
      .nodeId(d => d.id)
      .iterations(30);
    
    // Generate the layout
    const { nodes, links } = sankey(data);
    
    // Add nodes
    const node = svg.append("g")
      .selectAll(".node")
      .data(nodes)
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", d => `translate(${d.x0},${d.y0})`);
    
    node.append("rect")
      .attr("width", d => d.x1 - d.x0)
      .attr("height", d => d.y1 - d.y0)
      .attr("fill", d => d.id === "Per Protocol" ? "#0066cc" : 
                d.id === "Intention to Treat (Rescue Tx)" ? "#cc0000" : 
                d.id === "Success" ? "#4CAF50" : 
                d.id === "Complications (Failure?)" ? "#FF9800" : 
                d.id === "Revision surgery" ? "#F44336" : 
                d.id === "Non-Conserv Dt Tx" ? "#2196F3" : 
                d.id === "Recurrence" ? "#9C27B0" : 
                d.id === "AE" ? "#FF5722" : 
                "#607D8B")
      .attr("stroke", "black")
      .attr("stroke-width", 0.5);
    
    node.append("text")
      .attr("x", d => d.x0 + 10)
      .attr("y", d => d.y0 + 15)
      .attr("text-anchor", "left")
      .attr("font-size", "10px")
      .text(d => d.id)
      .attr("fill", "white");
    
    // Add links
    const link = svg.append("g")
      .selectAll(".link")
      .data(links)
      .enter().append("g")
      .attr("class", "link")
      .attr("transform", d => `translate(${d.x0},${d.y0})`);
    
    link.append("path")
      .attr("d", d => `M0,0L${d.x1 - d.x0},0L${d.x1 - d.x0},${d.y1 - d.y0}}L0,${d.y1 - d.y0}}Z`)
      .attr("fill", d => {
        if (d.source.id === "Per Protocol") return "#0066cc";
        if (d.source.id === "Intention to Treat (Rescue Tx)") return "#cc0000";
        if (d.target.id === "Success") return "#4CAF50";
        if (d.target.id === "Complications (Failure?)") return "#FF9800";
        if (d.target.id === "Revision surgery") return "#F44336";
        return "#607D8B";
      })
      .attr("stroke", "none")
      .attr("opacity", 0.8);
    
    // Add value labels
    link.append("text")
      .attr("x", d => d.x1 - d.x0)
      .attr("y", d => (d.y1 - d.y0)/2)
      .attr("text-anchor", "end")
      .attr("font-size", "10px")
      .text(d => d.value);
    
    // Add legend
    const legend = d3.select(".legend")
      .append("div")
      .style("display", "flex")
      .style("flex-wrap", "wrap")
      .style("margin", "10px 0");
    
    const legendItems = [
      { label: "Per Protocol", color: "#0066cc" },
      { label: "Rescue Tx", color: "#cc0000" },
      { label: "Success", color: "#4CAF50" },
      { label: "Complications", color: "#FF9800" },
      { label: "Revision Surgery", color: "#F44336" },
      { label: "Non-Conserv Dt Tx", color: "#2196F3" },
      { label: "Recurrence", color: "#9C27B0" },
      { label: "AE", color: "#FF5722" }
    ];
    
    legend.selectAll("div")
      .data(legendItems)
      .enter().append("div")
      .style("margin", "5px")
      .html(d => `<span style="display:inline-block; width:20px; height:10px; background-color:${d.color};"></span> ${d.label}`);
  </script>
</body>
</html>